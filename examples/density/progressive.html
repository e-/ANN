<!DOCTYPE html>
<body>
  <div>
    <input type="radio" name="type" value="density" id="type-density"><label for="type-density">Density Plot</label>
    <input type="radio" name="type" value="contour" id="type-contour" checked><label for="type-contour">Contour Plot</label>
  </div>
  <svg width="1000" height="1000"></svg>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://d3js.org/d3-contour.v1.min.js"></script>

  <script>
function translate(x, y) { return 'translate(' + x + ',' + y + ')'; }
let count = 0;

setInterval(() => {
  console.log(count)
  d3.csv('progressive.' + count + '.csv', (data) => {
    count += 1
    data.forEach((d) => {
      d.x = +d.x
      d.y = +d.y
      d.logP = Math.log(+d.p)
    })

    console.log(data)

    let svg = d3.select('svg')
    let g = svg.append('g')
    let width = 960, height = 960;
    let bins = 256
    let dict = {}

    data.forEach(d => {
      if(!dict[d.x]) dict[d.x] = {}
      dict[d.x][d.y] = d.logP
    })

    let countArray = [];
    
    for(let j = 0; j < bins; ++j) {
      for(let i = 0; i < bins; ++i) {
        if(!dict[i] || !dict[i][j]) countArray.push(0)
        else countArray.push(dict[i][j])
      }
    }

    svg.attr('width', width).attr('height', height)

    contour();
    d3.select('#type-density').on('click', density)
    d3.select('#type-contour').on('click', contour)

    function contour() {
      g.selectAll('*').remove();

      let color = d3.scaleSequential(d3.interpolateCool)
        .domain([0, d3.max(data, d => d.logP)])
      let max = d3.max(countArray)

      g.selectAll('path')
        .data(d3.contours()
          .size([bins, bins])
          .thresholds(d3.range(0, max, max / 5))
          (countArray)
        )
        .enter()
          .append('path')
          .attr('d', d3.geoPath(d3.geoIdentity().scale(width / bins)))
          .attr('fill', d => color(d.value))
    }

    function density() {
      g.selectAll('*').remove();

      let x = d3.scaleBand()
        .domain(d3.range(0, bins))
        .range([0, width])

      let y = d3.scaleBand()
        .domain(d3.range(0, bins))
        .range([0, height])

      let color = d3.scaleSequential(d3.interpolateCool)
        .domain([0, d3.max(data, d => d.logP)])

      g
        .selectAll('rect')
        .data(data)
        .enter()
          .append('rect')
          .attr('x', d => x(d.x))
          .attr('y', d => y(d.y))
          .attr('width', x.bandwidth())
          .attr('height', y.bandwidth())
          .attr('fill', d => color(d.logP))
    }
  })


}, 1000)

  </script>
</body>
